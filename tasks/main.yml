---
- name: Install Red Hat Certification rpms
  include: prepare.yml

- block:
  - name: Set compute tests
    set_fact:
      openstack_certification_tests: "{{ openstack_certification_tests_compute }}"
      #openstack_certification_tags: "{{ openstack_certification_tags_compute }}"
      #openstack_certification_programs: "{{ openstack_certification_programs_compute }}"

  - name: Run tests on compute nodes
    include: run_tests.yml
  when: "'compute' in group_names"

- block:
  - name: Set controller tests
    set_fact:
      openstack_certification_tests: "{{ openstack_certification_tests_controller }}"
      #openstack_certification_tags: "{{ openstack_certification_tags_controller }}"
      #openstack_certification_programs: "{{ openstack_certification_programs_controller }}"

  - name: Run tests on controller nodes
    include: run_tests.yml
  when: "'controller' in group_names"

- name: Retrieve certification test results
  become: True
  shell: rhcert-ci print --format {{ openstack_certification_output_format }} | tail -n +2 | tee {{ openstack_certification_output_filename }}

- name: Download output file
  become: True
  fetch:
    src: '{{ openstack_certification_output_filename }}'
    dest: "{{ openstack_certification_dest_dir }}/{{ openstack_certification_output_filename }}"
    flat: yes

- block:
  - name: Compress results file
    become: True
    archive:
      path: /var/rhcert/results.xml
      dest: /home/stack/certification.xml.gz
      format: gz

  - name: Download results file
    become: True
    fetch:
      src: 'certification.xml.gz'
      dest: "{{ openstack_certification_dest_dir }}/certification.xml.gz"
      flat: yes
  when: openstack_certification_results_download|bool

- name: Tempest cleanup
  become: True
  file:
    path: /tmp/tempest-lock
    state: absent
  when: "'tempest_config' in openstack_certification_tests"
